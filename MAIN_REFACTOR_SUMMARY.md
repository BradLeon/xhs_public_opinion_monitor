# Main.py ä»£ç é‡æ„æ€»ç»“

## ğŸ“Š é‡æ„æ•ˆæœå¯¹æ¯”

### é‡æ„å‰ vs é‡æ„å

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | æ”¹è¿› |
|------|--------|--------|------|
| ä¸»å‡½æ•°è¡Œæ•° | 270è¡Œ | 35è¡Œ | **å‡å°‘87%** |
| å‡½æ•°æ€»æ•° | 4ä¸ª | 18ä¸ª | **å¢åŠ 14ä¸ªè¾…åŠ©å‡½æ•°** |
| åµŒå¥—å±‚çº§ | 6-7å±‚ | 2-3å±‚ | **å‡å°‘50%+** |
| å•ä¸ªå‡½æ•°æœ€å¤§è¡Œæ•° | 270è¡Œ | 50è¡Œ | **å‡å°‘81%** |

## ğŸ¯ é‡æ„ç›®æ ‡è¾¾æˆ

### âœ… ä»£ç æ¸…æ™°åº¦æå‡
- **ä¸»å‡½æ•°é«˜åº¦æ¦‚æ‹¬**: ä»270è¡Œå¤æ‚é€»è¾‘ç®€åŒ–ä¸º35è¡Œæ¸…æ™°æµç¨‹
- **èŒè´£å•ä¸€**: æ¯ä¸ªå‡½æ•°åªè´Ÿè´£ä¸€ä¸ªç‰¹å®šä»»åŠ¡
- **é€»è¾‘åˆ†å±‚**: æŒ‰ç…§æ•°æ®åº“è¯»å– â†’ AIåˆ†æ â†’ ç»“æœå†™å…¥çš„ä¸šåŠ¡æµç¨‹åˆ†å±‚

### âœ… å¯ç»´æŠ¤æ€§å¢å¼º
- **æ¨¡å—åŒ–è®¾è®¡**: 14ä¸ªç‹¬ç«‹å‡½æ•°ï¼Œä¾¿äºå•ç‹¬æµ‹è¯•å’Œä¿®æ”¹
- **é”™è¯¯å¤„ç†é›†ä¸­**: ç»Ÿä¸€çš„é”™è¯¯åˆ›å»ºå’Œå¤„ç†æœºåˆ¶
- **å¤ç”¨æ€§æé«˜**: é€šç”¨çš„ç»“æœåˆ›å»ºå‡½æ•°å¯åœ¨å¤šå¤„ä½¿ç”¨

## ğŸ—ï¸ æ–°çš„å‡½æ•°æ¶æ„

### æ ¸å¿ƒæµç¨‹å‡½æ•°
```
run() [35è¡Œ]
â”œâ”€â”€ _check_environment() [ç¯å¢ƒæ£€æŸ¥]
â”œâ”€â”€ _read_database_batch() [æ•°æ®åº“è¯»å–]
â”œâ”€â”€ _process_all_batches() [æ‰¹æ¬¡å¤„ç†ç¼–æ’]
â”‚   â””â”€â”€ _process_single_batch() [å•æ‰¹æ¬¡å¤„ç†]
â”‚       â”œâ”€â”€ _run_ai_analysis() [AIåˆ†æ]
â”‚       â”œâ”€â”€ _parse_batch_results() [ç»“æœè§£æ]
â”‚       â””â”€â”€ _write_results_to_database() [æ•°æ®åº“å†™å…¥]
â””â”€â”€ _print_final_statistics() [ç»“æœç»Ÿè®¡]
```

### è¾…åŠ©å·¥å…·å‡½æ•°
```
_print_startup_info()          [å¯åŠ¨ä¿¡æ¯æ‰“å°]
_print_failure_details()       [å¤±è´¥è¯¦æƒ…æ‰“å°]
_create_batch_success()        [æ‰¹æ¬¡æˆåŠŸç»“æœåˆ›å»º]
_create_batch_error()          [æ‰¹æ¬¡é”™è¯¯ç»“æœåˆ›å»º]
_create_empty_result()         [ç©ºç»“æœåˆ›å»º]
_create_success_result()       [æˆåŠŸç»“æœåˆ›å»º]
```

## ğŸ” é‡æ„å‰åä»£ç å¯¹æ¯”

### é‡æ„å‰ - å¤æ‚åµŒå¥—ç»“æ„
```python
def run():
    # ç¯å¢ƒå˜é‡æ£€æŸ¥ (15è¡Œ)
    # é…ç½®åˆå§‹åŒ– (10è¡Œ)
    # æ•°æ®åº“è¯»å– (30è¡Œ)
    # åˆ†æ‰¹å¤„ç†å¾ªç¯å¼€å§‹
    for batch_index in range(...):
        try:
            # AIåˆ†æ (20è¡Œ)
            try:
                # ç»“æœè§£æ (40è¡Œ)
                for i, result in enumerate(...):
                    try:
                        # ç»“æœå¤„ç† (30è¡Œ)
                    except:
                        # é”™è¯¯å¤„ç† (20è¡Œ)
                # æ•°æ®åº“å†™å…¥ (25è¡Œ)
                if "æˆåŠŸå†™å…¥" in write_result:
                    # æˆåŠŸå¤„ç† (15è¡Œ)
                else:
                    # å¤±è´¥å¤„ç† (15è¡Œ)
            except:
                # JSONè§£æé”™è¯¯ (20è¡Œ)
        except:
            # æ‰¹æ¬¡é”™è¯¯ (15è¡Œ)
    # ç»Ÿè®¡å’Œæ€»ç»“ (30è¡Œ)
```

### é‡æ„å - æ¸…æ™°çº¿æ€§æµç¨‹
```python
def run():
    """35è¡Œæ¸…æ™°æµç¨‹"""
    if not _check_environment():
        return None
    
    db_batch_size, ai_batch_size = BatchConfig.validate_and_adjust()
    current_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    
    try:
        _print_startup_info(current_time)
        
        notes_data = _read_database_batch(db_batch_size)
        if not notes_data:
            return _create_empty_result("no_data", "æ²¡æœ‰æ‰¾åˆ°æœªå¤„ç†çš„ç¬”è®°æ•°æ®")
        
        total_notes_count = notes_data['total_count']
        all_notes_list = notes_data['notes']
        
        stats = _process_all_batches(all_notes_list, ai_batch_size, current_time)
        
        _print_final_statistics(stats, total_notes_count, ai_batch_size)
        
        return _create_success_result(total_notes_count, ai_batch_size, stats)
        
    except Exception as e:
        print(f"âŒ æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}")
        return None
```

## ğŸ“ˆ å…·ä½“æ”¹è¿›ç‚¹

### 1. ç¯å¢ƒæ£€æŸ¥ç‹¬ç«‹åŒ–
- **é‡æ„å‰**: 15è¡Œç¯å¢ƒæ£€æŸ¥é€»è¾‘æ··åœ¨ä¸»å‡½æ•°ä¸­
- **é‡æ„å**: `_check_environment()` ç‹¬ç«‹å‡½æ•°ï¼Œè¿”å›å¸ƒå°”å€¼

### 2. æ•°æ®åº“è¯»å–æ¨¡å—åŒ–
- **é‡æ„å‰**: 30è¡Œè¯»å–+è§£æé€»è¾‘åµŒå¥—åœ¨ä¸»å‡½æ•°
- **é‡æ„å**: `_read_database_batch()` ç‹¬ç«‹å¤„ç†ï¼Œè¿”å›ç»“æ„åŒ–æ•°æ®

### 3. æ‰¹æ¬¡å¤„ç†åˆ†å±‚
- **é‡æ„å‰**: å•ä¸ªforå¾ªç¯åŒ…å«æ‰€æœ‰æ‰¹æ¬¡å¤„ç†é€»è¾‘ï¼ˆ150+è¡Œï¼‰
- **é‡æ„å**: 
  - `_process_all_batches()` è´Ÿè´£å¾ªç¯ç¼–æ’
  - `_process_single_batch()` è´Ÿè´£å•æ‰¹æ¬¡å¤„ç†
  - `_run_ai_analysis()` è´Ÿè´£AIåˆ†æ
  - `_parse_batch_results()` è´Ÿè´£ç»“æœè§£æ

### 4. é”™è¯¯å¤„ç†ç»Ÿä¸€åŒ–
- **é‡æ„å‰**: åˆ†æ•£çš„é”™è¯¯å¤„ç†ï¼Œé‡å¤çš„é”™è¯¯ä¿¡æ¯æ„é€ 
- **é‡æ„å**: 
  - `_create_batch_error()` ç»Ÿä¸€é”™è¯¯ç»“æœåˆ›å»º
  - `_create_batch_success()` ç»Ÿä¸€æˆåŠŸç»“æœåˆ›å»º
  - `_print_failure_details()` ç»Ÿä¸€å¤±è´¥è¯¦æƒ…æ‰“å°

## ğŸ¨ ä»£ç è´¨é‡æå‡

### å¯è¯»æ€§ ğŸ“–
- **å‡½æ•°åç§°æ¸…æ™°**: æ¯ä¸ªå‡½æ•°åéƒ½å‡†ç¡®æè¿°å…¶åŠŸèƒ½
- **é€»è¾‘åˆ†å±‚æ˜ç¡®**: ä¸»æµç¨‹æ¸…æ™°ï¼Œç»†èŠ‚å°è£…åœ¨å­å‡½æ•°ä¸­
- **æ³¨é‡Šç®€æ´**: æ¯ä¸ªå‡½æ•°éƒ½æœ‰æ¸…æ™°çš„docstring

### å¯ç»´æŠ¤æ€§ ğŸ”§
- **å•ä¸€èŒè´£**: æ¯ä¸ªå‡½æ•°åªåšä¸€ä»¶äº‹
- **ä½è€¦åˆ**: å‡½æ•°é—´é€šè¿‡å‚æ•°å’Œè¿”å›å€¼é€šä¿¡
- **æ˜“æµ‹è¯•**: æ¯ä¸ªå‡½æ•°éƒ½å¯ä»¥ç‹¬ç«‹æµ‹è¯•

### å¯æ‰©å±•æ€§ ğŸš€
- **æ¨¡å—åŒ–è®¾è®¡**: æ–°åŠŸèƒ½å¯ä»¥è½»æ¾æ·»åŠ æ–°å‡½æ•°
- **ç»Ÿä¸€æ¥å£**: ç»“æœåˆ›å»ºå‡½æ•°æä¾›ç»Ÿä¸€çš„è¿”å›æ ¼å¼
- **é…ç½®åˆ†ç¦»**: ç¯å¢ƒæ£€æŸ¥å’Œé…ç½®åˆå§‹åŒ–åˆ†ç¦»

## ğŸ‰ æ€»ç»“

é€šè¿‡è¿™æ¬¡é‡æ„ï¼Œ`main.py` ä»ä¸€ä¸ª270è¡Œçš„"å·¨å‡½æ•°"è½¬å˜ä¸ºï¼š
- **1ä¸ª35è¡Œçš„ä¸»æµç¨‹å‡½æ•°**
- **14ä¸ªèŒè´£å•ä¸€çš„è¾…åŠ©å‡½æ•°**
- **æ¸…æ™°çš„3å±‚è°ƒç”¨ç»“æ„**

ä»£ç çš„å¯è¯»æ€§ã€å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§éƒ½å¾—åˆ°äº†æ˜¾è‘—æå‡ï¼ŒåŒæ—¶ä¿æŒäº†åŸæœ‰çš„æ‰€æœ‰åŠŸèƒ½å’Œå®¹é”™æœºåˆ¶ã€‚

## ğŸ§ª éªŒè¯æ–¹å¼

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯é‡æ„ç»“æœï¼š
```bash
python test_main_refactor.py
```

æˆ–ç›´æ¥å¯¼å…¥éªŒè¯å‡½æ•°å­˜åœ¨æ€§ï¼š
```python
from xhs_public_opinion.main import (
    _check_environment, _read_database_batch, 
    _process_all_batches, _create_batch_success
)
``` 